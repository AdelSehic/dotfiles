#!/bin/bash

ssh_user="root"
ssh_host="10.1.170.237"
remote_folder="/opt/pbxware/pw/usr/bin"
binary_path="/opt/pbxware/sh/pbxware"

# Check if app is provided
if [ $# -eq 0 ]; then
    echo "Usage: $0 <app>"
    exit 1
fi
app="$1"
target="$HOME/pbxware/$app"

if [ -n "$2" ] && [ "$2" = "mt" ]; then
    ssh_host="10.1.170.236"
elif [ -n "$2" ] && [ "$2" = "cc" ]; then
    ssh_host="192.168.100.17"
elif [ -n "$2" ] && [ "$2" = "r" ]; then
    # just restart the app
    ssh "$ssh_user@$ssh_host" "$binary_path stop $app"
    ssh "$ssh_user@$ssh_host" "$binary_path start $app"
    exit 0
fi

cd "$target" || exit
if ! make -C "$target"; then
    exit 1
fi

ssh "$ssh_user@$ssh_host" "$binary_path stop $app"

wait

scp "$target/$app" "$ssh_user@$ssh_host:$remote_folder"
ssh "$ssh_user@$ssh_host" "$binary_path start $app"
